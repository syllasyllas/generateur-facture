<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENERATEUR FACTURE MONCOLIS.CI</title>
    <style>
        :root {
            --primary-color: #ff8c00; /* Orange MONCOLIS */
            --secondary-color: #333;
            --light-gray: #f4f7f6;
            --text-color: #333;
        }
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-gray);
            font-size: 16px;
        }
        #main-content {
            display: none;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }
        .modal-box h2 {
            margin-top: 0;
            color: var(--secondary-color);
        }
        .pin-input {
            padding: 12px;
            font-size: 20px;
            text-align: center;
            width: 150px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .error-message {
            color: red;
            display: none;
            margin-top: 10px;
        }
        .conteneur {
            width: 100%;
            max-width: 800px;
        }
        .formulaire, .apercu-recu, .base-de-donnees, .gestion-contacts {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .champ {
            margin-bottom: 18px;
        }
        .champ-groupe {
            display: flex;
            gap: 20px;
        }
        .champ-groupe .champ {
            width: 100%;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-color);
        }
        input[type="text"], input[type="number"], textarea, select {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            transition: border-color 0.3s, background-color 0.3s;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
        }
        select {
             width: 100%;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .checkbox-container label {
            margin-bottom: 0;
            font-weight: normal;
        }
        .bouton-groupe {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        button {
            display: inline-block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, opacity 0.3s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .bouton-principal {
            background-color: var(--primary-color);
            color: white;
        }
        .bouton-principal:hover:not(:disabled) {
            background-color: #e67e00;
        }
        .bouton-secondaire {
            background-color: #6c757d;
            color: white;
        }
        .bouton-secondaire:hover:not(:disabled) {
            background-color: #5a6268;
        }
        .bouton-tertiaire {
            background-color: #17a2b8;
            color: white;
        }
        .bouton-tertiaire:hover:not(:disabled) {
            background-color: #138496;
        }
        .bouton-danger {
            background-color: #dc3545;
        }
        .bouton-danger:hover:not(:disabled) {
            background-color: #c82333;
        }
        
        #recu {
            border: 1px solid #e0e0e0;
            padding: 25px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        #recu::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            transform: translate(-50%, -50%);
            background-image: url('https://i.postimg.cc/ncnzhbWX/Design-sans-titre-3.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.08;
            pointer-events: none;
            z-index: 1;
        }
        .invoice-content {
            position: relative;
            z-index: 2;
        }
        .header-recu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .logo {
            max-width: 350px;
        }
        .infos-entreprise {
            text-align: right;
            font-size: 1em;
            color: #555;
        }
        .corps-recu {
            margin-top: 20px;
        }
        .titre-facture {
            text-align: center;
            font-size: 2.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        .infos-transaction {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        .details-expedition, .details-contenu {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(249, 250, 251, 0.8);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .parties-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .partie {
            width: 48%;
        }
        .partie strong, .details-expedition strong, .details-contenu strong {
            color: var(--primary-color);
        }
        .table-contenu {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        .table-contenu th, .table-contenu td {
            border: 1.5px solid #333;
            padding: 12px;
            text-align: left;
            font-size: 1em;
        }
        .table-contenu th {
            background-color: rgba(241, 245, 249, 0.8);
            font-weight: 600;
        }
        .table-contenu td:nth-child(2), .table-contenu td:nth-child(3) {
            text-align: right;
        }
        .resume-financier {
            margin-top: 20px;
            padding-left: 50%;
        }
        .resume-financier table {
            width: 100%;
            border-collapse: collapse;
        }
        .resume-financier td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .resume-financier .grand-total td {
            font-weight: bold;
            font-size: 1.2em;
            color: #D32F2F;
            border-top: 2px solid #333;
        }
        .pied-recu {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            font-size: 0.9em;
            color: #666;
        }
        .note-importante {
            font-weight: bold;
            color: #D32F2F;
            background-color: rgba(255, 235, 238, 0.8);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        .signatures {
            margin-top: 100px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .zone-signature {
            border-top: 1px solid #333;
            width: 45%;
            text-align: center;
            padding-top: 8px;
            font-size: 1em;
            height: 150px;
        }
        .remerciements {
            text-align: left;
            margin-top: 40px;
            font-style: italic;
        }
        
        /* NOUVEAUX STYLES POUR LA BASE DE DONNÉES */
        .week-group .week-header {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-group .week-header::after {
            content: '▼';
            font-size: 0.8em;
            transition: transform 0.3s;
        }
        .week-group .week-header.active::after {
            transform: rotate(180deg);
        }
        .week-content {
            padding: 0 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .db-entry {
            border: 1.5px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background-color: #f9f9f9;
        }
        .db-entry p {
            margin: 8px 0;
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 10px;
        }
        .db-entry strong {
            font-weight: 600;
            color: #555;
        }
        .invoice-link {
            cursor: pointer;
            color: var(--primary-color);
            text-decoration: underline;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            #main-content { flex-direction: column; }
            .conteneur, .formulaire, .apercu-recu, .base-de-donnees { padding: 15px; }
            .champ-groupe, .parties-container, .signatures, .bouton-groupe { flex-direction: column; gap: 15px; }
            .partie, .zone-signature { width: 100%; }
            .resume-financier { padding-left: 0; }
            .signatures { gap: 50px; }
            .db-entry p { grid-template-columns: 140px 1fr; }
        }

        @media print {
            @page { size: A4; margin: 5mm; }
            html, body { width: 210mm; height: 297mm; overflow: hidden; font-size: 10pt; }
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #main-content { display: block !important; }
            .formulaire, .boutons-actions, h2, .base-de-donnees, #login-overlay, #delete-overlay, .gestion-contacts { display: none !important; }
            .apercu-recu { box-shadow: none !important; width: 100% !important; padding: 0 !important; margin: 0 !important; border: none !important; }
            #recu { border: none !important; padding: 0 !important; display: flex; flex-direction: column; justify-content: space-between; min-height: calc(297mm - 10mm); page-break-inside: avoid !important; }
            #recu::before { opacity: 0.06 !important; }
            .logo { max-width: 250px !important; }
            .titre-facture { font-size: 1.8em !important; margin-bottom: 10px !important; }
            .details-expedition, .details-contenu { padding: 8px !important; margin-top: 10px !important; }
            .table-contenu th, .table-contenu td { padding: 6px !important; border: 1px solid #000 !important; }
            .resume-financier { padding-left: 0 !important; margin-top: 10px !important; }
            .pied-recu { margin-top: 25px !important; padding-top: 10px !important; }
            .signatures { margin-top: 60px !important; page-break-inside: avoid !important; }
            .zone-signature { height: 80px !important; }
            .note-importante { background-color: #f0f0f0 !important; padding: 8px !important; }
        }
    </style>
</head>
<body>
    <div id="login-overlay" class="overlay">
        <div class="modal-box">
            <h2>Accès Sécurisé</h2>
            <p>Veuillez entrer le code PIN pour continuer.</p>
            <input type="password" id="pin-input" class="pin-input" maxlength="4" autofocus>
            <button type="button" onclick="checkPin()" class="bouton-principal">Entrer</button>
            <p id="error-message-login" class="error-message">Code PIN incorrect.</p>
        </div>
    </div>

    <div id="delete-overlay" class="overlay" style="display: none;">
        <div class="modal-box">
            <h2>Confirmation Requise</h2>
            <p>Entrez le code PIN pour vider la base de données.</p>
            <input type="password" id="delete-pin-input" class="pin-input" maxlength="4">
            <div class="bouton-groupe">
                <button type="button" onclick="confirmerSuppression()" class="bouton-danger">Confirmer</button>
                <button type="button" onclick="document.getElementById('delete-overlay').style.display = 'none'" class="bouton-secondaire">Annuler</button>
            </div>
            <p id="error-message-delete" class="error-message">Code PIN incorrect.</p>
        </div>
    </div>

    <div id="main-content">
        <div class="conteneur formulaire">
            <form id="invoiceForm">
                <h1>GENERATEUR FACTURE MONCOLIS.CI</h1>
                
                <div class="champ"><label for="clientNom">Nom & Prénom du Destinataire</label><input type="text" id="clientNom" placeholder="Ex: Jean Dupont"></div>
                <div class="champ"><label for="clientContact">Contact du Destinataire</label><input type="text" id="clientContact" placeholder="Ex: 0102030405"></div>
                <div class="champ"><label for="clientAdresse">Adresse</label><input type="text" id="clientAdresse" placeholder="Ex: 123 Rue de l'Exemple"></div>
                <div class="champ"><label for="clientCodePostal">Code Postal</label><input type="text" id="clientCodePostal" placeholder="Ex: 75001"></div>
                <div class="champ"><label for="clientPays">Pays</label><select id="clientPays"></select></div>
                <hr style="border: 1px solid #f0f0f0; margin: 25px 0;">
                
                <div class="champ"><label for="expediteur">Nom de l'Expéditeur</label><input type="text" id="expediteur" placeholder="Nom de la personne qui dépose le colis"></div>
                <div class="champ"><label for="expediteurContact">Contact de l'Expéditeur</label><input type="text" id="expediteurContact" placeholder="Ex: 0708091011"></div>
                <div class="champ"><label for="expediteurPiece">N° Pièce d'Identité (Expéditeur)</label><input type="text" id="expediteurPiece" placeholder="Ex: C00123456789"></div>
                <hr style="border: 1px solid #f0f0f0; margin: 25px 0;">

                <div class="champ"><label for="description">Description</label><textarea id="description" rows="2" placeholder="Ex: Vêtements, documents..."></textarea></div>
                <div class="champ-groupe">
                    <div class="champ"><label for="unitType">Unité</label><select id="unitType"><option value="Poids/KG">Poids/KG</option><option value="CBM">CBM</option></select></div>
                    <div class="champ"><label for="unitValue">Valeur de l'unité</label><input type="number" id="unitValue" placeholder="Ex: 5"></div>
                </div>
                <div class="champ"><label for="montant">Montant (FCFA)</label><input type="number" id="montant" placeholder="Ex: 25000"></div>
                <div class="champ"><label for="valeurColis">Valeur du Colis</label><input type="number" id="valeurColis" placeholder="Ex: 100000"></div>
                <div class="champ"><label for="prixDeclare">Prix Déclaré Pris en Compte</label><input type="number" id="prixDeclare" placeholder="Ex: 100000"></div>
                <div class="champ">
                    <div class="checkbox-container"><input type="checkbox" id="hasReduction" onchange="toggleReductionInput()"><label for="hasReduction">Appliquer une réduction</label></div>
                    <input type="number" id="reduction" placeholder="Saisir le montant de la réduction" disabled>
                </div>
                <div class="champ">
                     <div class="checkbox-container"><input type="checkbox" id="hasTracking" onchange="toggleTrackingInput()"><label for="hasTracking">Le colis a un numéro de tracking</label></div>
                    <input type="text" id="tracking" placeholder="Saisir le numéro de tracking" disabled>
                </div>

                <div class="bouton-groupe">
                    <button type="button" onclick="genererFacture()" class="bouton-principal">Générer & Sauvegarder</button>
                    <button type="button" onclick="reinitialiserFacture()" class="bouton-secondaire">Réinitialiser</button>
                </div>
            </form>
        </div>

        <div class="conteneur apercu-recu">
            <h2>Aperçu de la Facture</h2>
            <div id="recu">
                <div class="invoice-content">
                    <div> <!-- Conteneur pour le haut de la facture -->
                        <div class="header-recu">
                            <div><img src="https://i.postimg.cc/ncnzhbWX/Design-sans-titre-3.png" alt="Logo MONCOLIS.CI" class="logo"></div>
                            <div class="infos-entreprise">
                                <strong>MONCOLIS.CI</strong><br>
                                <span style="font-size: 12px; color: #777;">Une filiale de EKF-CORPORATION</span><br><br>
                                Cocody Riviera Palmeraie, Rue Ministre, Abidjan<br>
                                Téléphone : +225 07 49 75 55 19<br>
                                N° Registre : RVN: CI-ABJ-03-2021-B12-01877
                            </div>
                        </div>

                        <div class="corps-recu">
                            <div class="titre-facture">FACTURE</div>
                            <div class="infos-transaction">
                                <div><strong>Date :</strong> <span id="facture-date">-</span><br><strong>N° Facture :</strong> <span id="facture-num">-</span></div>
                            </div>

                            <div class="details-expedition">
                                <div class="parties-container">
                                    <div class="partie">
                                        <strong>Destinataire :</strong><br>
                                        Nom : <span id="facture-clientNom">-</span><br>
                                        Contact : <span id="facture-clientContact">-</span><br>
                                        Adresse : <span id="facture-clientAdresse">-</span><br>
                                        <span id="facture-clientCodePostal"></span> <span id="facture-clientPays">-</span>
                                    </div>
                                    <div class="partie">
                                        <strong>Expéditeur :</strong><br>
                                        Nom : <span id="facture-expediteur">-</span><br>
                                        Contact : <span id="facture-expediteurContact">-</span><br>
                                        N° Pièce d'Identité : <span id="facture-expediteurPiece">-</span>
                                    </div>
                                </div>
                                <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 15px 0;">
                                <div><strong>Numéro de Tracking :</strong> <span id="facture-tracking" style="color: red; font-weight: bold;">-</span></div>
                            </div>

                            <div class="details-contenu">
                                <strong>Détails du Contenu du Colis :</strong>
                                <table class="table-contenu">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th id="header-unit">Poids/KG</th>
                                            <th>Montant</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td id="facture-description">-</td>
                                            <td id="facture-unitValue">-</td>
                                            <td id="facture-montant">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="resume-financier">
                                    <table>
                                        <tbody>
                                            <tr><td>Valeur du Colis :</td><td style="text-align:right;"><span id="facture-valeurColis">0</span> FCFA</td></tr>
                                            <tr><td>Prix Déclaré Pris en Compte :</td><td style="text-align:right;"><span id="facture-prixDeclare">0</span> FCFA</td></tr>
                                            <tr id="ligne-reduction" style="display:none;"><td>Réduction :</td><td style="text-align:right;">- <span id="facture-reduction">0</span> FCFA</td></tr>
                                            <tr class="grand-total"><td>GRAND TOTAL :</td><td style="text-align:right;"><span id="facture-grandTotal">0</span> FCFA</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pied-recu">
                        <p class="note-importante">Important : Les charges de la douane sont à la responsabilité exclusive du client.</p>
                        <div class="signatures">
                            <div class="zone-signature">Signature de l'Expéditeur</div>
                            <div class="zone-signature">Signature de l'Agence</div>
                        </div>
                        <p class="remerciements">Nous vous remercions de votre confiance.</p>
                    </div>
                </div>
            </div>
            <div class="boutons-actions" style="margin-top:20px;">
                <div class="bouton-groupe">
                    <button id="printBtn" class="bouton-principal" onclick="window.print()" disabled>🖨️ Imprimer</button>
                    <button id="emailBtn" class="bouton-tertiaire" onclick="envoyerEmail()" disabled>✉️ Envoyer par E-mail</button>
                </div>
            </div>
        </div>

        <div class="conteneur base-de-donnees">
            <h2>📊 Base de Données des Factures</h2>
            <div id="dbList">
                <!-- Les factures sauvegardées apparaîtront ici -->
            </div>
            <button onclick="demanderPinPourSuppression()" class="bouton-danger" style="margin-top: 20px; width: 100%;">Vider la Base de Données</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCP-HMUYTKPc8qJx0IP0Zy1AEE6YNiAv6I",
            authDomain: "facture-moncolis.firebaseapp.com",
            projectId: "facture-moncolis",
            storageBucket: "facture-moncolis.appspot.com",
            messagingSenderId: "423934430446",
            appId: "1:423934430446:web:789b35c6a3a66ed70df7ff"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const facturesCollection = db.collection("factures");
        let facturesCache = [];

        let numeroFactureActuel = '';
        let inactivityTimer;

        function logout() {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-input').focus();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logout, 3600 * 1000); // 1 heure
        }

        function setupInactivityListeners() {
            const activityEvents = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
            activityEvents.forEach(event => {
                window.addEventListener(event, resetInactivityTimer, true);
            });
        }

        function checkPin() {
            const correctPin = "5008";
            const enteredPin = document.getElementById('pin-input').value;
            const errorMessage = document.getElementById('error-message-login');

            if (enteredPin === correctPin) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                resetInactivityTimer();
                setupInactivityListeners();
                chargerBaseDeDonnees();
            } else {
                errorMessage.style.display = 'block';
                document.getElementById('pin-input').value = '';
            }
        }
        document.getElementById('pin-input').addEventListener('keyup', function(event) {
            if (event.key === "Enter") {
                checkPin();
            }
        });

        function toggleTrackingInput() {
            const trackingInput = document.getElementById('tracking');
            const hasTrackingCheckbox = document.getElementById('hasTracking');
            trackingInput.disabled = !hasTrackingCheckbox.checked;
            if (!hasTrackingCheckbox.checked) {
                trackingInput.value = '';
            }
        }
        
        function toggleReductionInput() {
            const reductionInput = document.getElementById('reduction');
            const hasReductionCheckbox = document.getElementById('hasReduction');
            reductionInput.disabled = !hasReductionCheckbox.checked;
            if (!hasReductionCheckbox.checked) {
                reductionInput.value = '';
            }
        }

        function reinitialiserFacture() {
            document.getElementById('invoiceForm').reset();
            populateCountries();
            
            const fieldsToReset = [
                'facture-date', 'facture-num', 'facture-clientNom', 'facture-clientContact', 
                'facture-clientAdresse', 'facture-clientCodePostal', 'facture-clientPays',
                'facture-expediteur', 'facture-expediteurContact', 
                'facture-expediteurPiece', 'facture-tracking', 'facture-description', 'facture-unitValue'
            ];
            fieldsToReset.forEach(id => {
                document.getElementById(id).innerText = '-';
            });
            
            document.getElementById('facture-montant').innerText = '-';
            document.getElementById('facture-valeurColis').innerText = '0';
            document.getElementById('facture-prixDeclare').innerText = '0';
            document.getElementById('facture-grandTotal').innerText = '0';
            document.getElementById('ligne-reduction').style.display = 'none';

            document.getElementById('printBtn').disabled = true;
            document.getElementById('emailBtn').disabled = true;
            numeroFactureActuel = '';

            toggleTrackingInput();
            toggleReductionInput();
        }

        function getWeekKey(date) {
            const startOfWeek = new Date(date.valueOf());
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Lundi est le début
            startOfWeek.setDate(diff);

            const endOfWeek = new Date(startOfWeek.valueOf());
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            const optionsStart = { day: '2-digit', month: 'long' };
            const optionsEnd = { day: '2-digit', month: 'long', year: 'numeric' };
            
            const startStr = startOfWeek.toLocaleDateString('fr-FR', optionsStart);
            const endStr = endOfWeek.toLocaleDateString('fr-FR', optionsEnd);

            return `Semaine du ${startStr} au ${endStr}`;
        }

        function chargerBaseDeDonnees() {
            facturesCollection.orderBy("timestamp", "desc").onSnapshot(snapshot => {
                const dbList = document.getElementById('dbList');
                dbList.innerHTML = '';
                facturesCache = [];
                const groupedInvoices = {};

                snapshot.forEach(doc => {
                    const facture = doc.data();
                    facture.id = doc.id;
                    facturesCache.push(facture);
                    
                    const date = facture.timestamp ? facture.timestamp.toDate() : new Date();
                    const weekKey = getWeekKey(date);
                    if (!groupedInvoices[weekKey]) {
                        groupedInvoices[weekKey] = [];
                    }
                    groupedInvoices[weekKey].push(facture);
                });

                const currentWeekKey = getWeekKey(new Date());

                for (const weekKey in groupedInvoices) {
                    const weekGroup = document.createElement('div');
                    weekGroup.className = 'week-group';

                    const weekHeader = document.createElement('div');
                    weekHeader.className = 'week-header';
                    weekHeader.innerText = weekKey;
                    
                    const weekContent = document.createElement('div');
                    weekContent.className = 'week-content';

                    groupedInvoices[weekKey].forEach(facture => {
                        ajouterFactureAuTableau(facture, weekContent);
                    });

                    weekHeader.addEventListener('click', () => {
                        weekHeader.classList.toggle('active');
                        if (weekContent.style.maxHeight) {
                            weekContent.style.maxHeight = null;
                        } else {
                            weekContent.style.maxHeight = weekContent.scrollHeight + "px";
                        }
                    });

                    weekGroup.appendChild(weekHeader);
                    weekGroup.appendChild(weekContent);
                    dbList.appendChild(weekGroup);

                    if (weekKey === currentWeekKey) {
                        weekHeader.classList.add('active');
                        weekContent.style.maxHeight = weekContent.scrollHeight + "px";
                    }
                }

            }, error => {
                console.error("Erreur de lecture de la base de données: ", error);
                alert("Erreur de connexion à la base de données. Vérifiez votre configuration Firebase et vos règles de sécurité.");
            });
        }

        function ajouterFactureAuTableau(facture, container) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'db-entry';

            entryDiv.innerHTML = `
                <p><strong>N° Facture:</strong> <a href="#" class="invoice-link" onclick="afficherApercuParId('${facture.id}')">${facture.numero}</a></p>
                <p><strong>Date:</strong> <span>${facture.date} à ${facture.heure}</span></p>
                <p><strong>Destinataire:</strong> <span>${facture.destinataire}</span></p>
                <p><strong>Téléphone Dest.:</strong> <span>${facture.telephone}</span></p>
                <p><strong>Contact Expéd.:</strong> <span>${facture.expediteurContact}</span></p>
                <p><strong>Grand Total:</strong> <span>${facture.total} FCFA</span></p>
                <button onclick="dupliquerFacture('${facture.id}')" class="bouton-secondaire" style="width:auto; padding: 8px 12px; font-size: 14px; margin-top: 10px;">Dupliquer</button>
            `;
            container.appendChild(entryDiv);
        }
        
        function demanderPinPourSuppression() {
            document.getElementById('delete-overlay').style.display = 'flex';
            document.getElementById('delete-pin-input').focus();
            document.getElementById('error-message-delete').style.display = 'none';
        }

        function confirmerSuppression() {
            const correctPin = "5008";
            const enteredPin = document.getElementById('delete-pin-input').value;
            const errorMessage = document.getElementById('error-message-delete');

            if (enteredPin === correctPin) {
                facturesCollection.get().then(querySnapshot => {
                    const batch = db.batch();
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                }).then(() => {
                    console.log("Base de données vidée.");
                    document.getElementById('delete-overlay').style.display = 'none';
                    document.getElementById('delete-pin-input').value = '';
                });
            } else {
                errorMessage.style.display = 'block';
                document.getElementById('delete-pin-input').value = '';
            }
        }

        function envoyerEmail() {
            const recipient = 'syllasylla@icloud.com';
            const subject = `Facture N° ${numeroFactureActuel}`;
            const body = `Bonjour,\n\nLa facture N°${numeroFactureActuel} a été générée.\n\nPour la visualiser, veuillez l'imprimer en format PDF depuis l'application.\n\nCordialement,\nMONCOLIS.CI`;
            const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        function afficherApercuParId(factureId) {
            const facture = facturesCache.find(f => f.id === factureId);
            if (facture) {
                afficherApercu(facture);
            }
        }

        function dupliquerFacture(factureId) {
            const facture = facturesCache.find(f => f.id === factureId);
            if (!facture) return;

            // Remplir le formulaire
            document.getElementById('clientNom').value = facture.destinataire;
            document.getElementById('clientContact').value = facture.telephone;
            document.getElementById('clientAdresse').value = facture.clientAdresse;
            document.getElementById('clientCodePostal').value = facture.clientCodePostal;
            document.getElementById('clientPays').value = facture.clientPays;
            document.getElementById('expediteur').value = facture.expediteur;
            document.getElementById('expediteurContact').value = facture.expediteurContact;
            document.getElementById('expediteurPiece').value = facture.expediteurPiece;
            document.getElementById('description').value = facture.description;
            document.getElementById('unitType').value = facture.unitType;
            document.getElementById('unitValue').value = facture.unitValue;
            document.getElementById('montant').value = facture.montant;
            document.getElementById('valeurColis').value = facture.valeurColis;
            document.getElementById('prixDeclare').value = facture.prixDeclare;

            // Gérer les cases à cocher
            const hasTrackingCheckbox = document.getElementById('hasTracking');
            if (facture.trackingValue !== "Non applicable") {
                hasTrackingCheckbox.checked = true;
                document.getElementById('tracking').value = facture.trackingValue;
            } else {
                hasTrackingCheckbox.checked = false;
            }
            toggleTrackingInput();

            const hasReductionCheckbox = document.getElementById('hasReduction');
            if (facture.reduction > 0) {
                hasReductionCheckbox.checked = true;
                document.getElementById('reduction').value = facture.reduction;
            } else {
                hasReductionCheckbox.checked = false;
            }
            toggleReductionInput();

            // Remonter en haut de la page
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function afficherApercu(facture) {
            if (!facture) return;

            document.getElementById('facture-date').innerText = facture.date;
            document.getElementById('facture-num').innerText = facture.numero;
            document.getElementById('facture-clientNom').innerText = facture.destinataire;
            document.getElementById('facture-clientContact').innerText = facture.telephone;
            document.getElementById('facture-clientAdresse').innerText = facture.clientAdresse;
            document.getElementById('facture-clientCodePostal').innerText = facture.clientCodePostal;
            document.getElementById('facture-clientPays').innerText = facture.clientPays;
            document.getElementById('facture-expediteur').innerText = facture.expediteur;
            document.getElementById('facture-expediteurContact').innerText = facture.expediteurContact;
            document.getElementById('facture-expediteurPiece').innerText = facture.expediteurPiece;
            document.getElementById('facture-tracking').innerText = facture.trackingValue;
            
            document.getElementById('header-unit').innerText = facture.unitType;
            document.getElementById('facture-description').innerText = facture.description;
            document.getElementById('facture-unitValue').innerText = facture.unitValue;
            document.getElementById('facture-montant').innerText = facture.montant.toLocaleString('fr-FR') + " FCFA";
            
            document.getElementById('facture-valeurColis').innerText = (facture.valeurColis || "0").toLocaleString('fr-FR');
            document.getElementById('facture-prixDeclare').innerText = (facture.prixDeclare || "0").toLocaleString('fr-FR');
            
            const ligneReduction = document.getElementById('ligne-reduction');
            if (facture.reduction > 0) {
                document.getElementById('facture-reduction').innerText = facture.reduction.toLocaleString('fr-FR');
                ligneReduction.style.display = 'table-row';
            } else {
                ligneReduction.style.display = 'none';
            }
            
            document.getElementById('facture-grandTotal').innerText = facture.total;

            document.getElementById('printBtn').disabled = false;
            document.getElementById('emailBtn').disabled = false;
            numeroFactureActuel = facture.numero;
        }

        function genererFacture() {
            const maintenant = new Date();
            const dateStr = maintenant.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const heureStr = maintenant.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            numeroFactureActuel = 'FACT-' + maintenant.getTime(); 

            const clientNom = document.getElementById('clientNom').value;
            const clientContact = document.getElementById('clientContact').value;
            const clientAdresse = document.getElementById('clientAdresse').value;
            const clientCodePostal = document.getElementById('clientCodePostal').value;
            const clientPays = document.getElementById('clientPays').value;
            const expediteur = document.getElementById('expediteur').value;
            const expediteurContact = document.getElementById('expediteurContact').value;
            const expediteurPiece = document.getElementById('expediteurPiece').value;
            const description = document.getElementById('description').value;
            const unitType = document.getElementById('unitType').value;
            const unitValue = document.getElementById('unitValue').value;
            const montant = parseFloat(document.getElementById('montant').value) || 0;
            const valeurColis = document.getElementById('valeurColis').value;
            const prixDeclare = document.getElementById('prixDeclare').value;
            
            let reduction = 0;
            if (document.getElementById('hasReduction').checked) {
                reduction = parseFloat(document.getElementById('reduction').value) || 0;
            }
            
            let trackingValue = "Non applicable";
            if (document.getElementById('hasTracking').checked) {
                trackingValue = document.getElementById('tracking').value || "-";
            }
            
            const grandTotal = montant - reduction;

            const factureData = {
                numero: numeroFactureActuel,
                date: dateStr,
                heure: heureStr,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                destinataire: clientNom || "-",
                telephone: clientContact || "-",
                clientAdresse: clientAdresse || "-",
                clientCodePostal: clientCodePostal || "",
                clientPays: clientPays || "-",
                expediteur: expediteur || "-",
                expediteurContact: expediteurContact || "-",
                expediteurPiece: expediteurPiece || "-",
                description: description || "-",
                unitType: unitType,
                unitValue: unitValue || "-",
                montant: montant,
                valeurColis: valeurColis || "0",
                prixDeclare: prixDeclare || "0",
                reduction: reduction,
                trackingValue: trackingValue,
                total: grandTotal.toLocaleString('fr-FR')
            };
            
            afficherApercu(factureData);

            facturesCollection.add(factureData)
                .then((docRef) => {
                    console.log("Facture sauvegardée avec l'ID: ", docRef.id);
                })
                .catch((error) => {
                    console.error("Erreur lors de la sauvegarde de la facture: ", error);
                    alert("ERREUR: La facture n'a pas pu être sauvegardée en ligne. Vérifiez la console pour les détails.");
                });
        }

        function populateCountries() {
            const countries = ["Afghanistan","Afrique du Sud","Albanie","Algérie","Allemagne","Andorre","Angola","Antigua-et-Barbuda","Arabie saoudite","Argentine","Arménie","Australie","Autriche","Azerbaïdjan","Bahamas","Bahreïn","Bangladesh","Barbade","Belgique","Belize","Bénin","Bhoutan","Biélorussie","Birmanie","Bolivie","Bosnie-Herzégovine","Botswana","Brésil","Brunei","Bulgarie","Burkina Faso","Burundi","Cambodge","Cameroun","Canada","Cap-Vert","Chili","Chine","Chypre","Colombie","Comores","Congo-Brazzaville","Congo-Kinshasa","Corée du Nord","Corée du Sud","Costa Rica","Côte d'Ivoire","Croatie","Cuba","Danemark","Djibouti","Dominique","Égypte","Émirats arabes unis","Équateur","Érythrée","Espagne","Estonie","Eswatini","État de Palestine","États-Unis","Éthiopie","Fidji","Finlande","France","Gabon","Gambie","Géorgie","Ghana","Grèce","Grenade","Guatemala","Guinée","Guinée équatoriale","Guinée-Bissau","Guyana","Haïti","Honduras","Hongrie","Îles Marshall","Îles Salomon","Inde","Indonésie","Irak","Iran","Irlande","Islande","Israël","Italie","Jamaïque","Japon","Jordanie","Kazakhstan","Kenya","Kirghizistan","Kiribati","Koweït","Laos","Lesotho","Lettonie","Liban","Liberia","Libye","Liechtenstein","Lituanie","Luxembourg","Macédoine du Nord","Madagascar","Malaisie","Malawi","Maldives","Mali","Malte","Maroc","Maurice","Mauritanie","Mexique","Micronésie","Moldavie","Monaco","Mongolie","Monténégro","Mozambique","Namibie","Nauru","Népal","Nicaragua","Niger","Nigeria","Norvège","Nouvelle-Zélande","Oman","Ouganda","Ouzbékistan","Pakistan","Palaos","Panama","Papouasie-Nouvelle-Guinée","Paraguay","Pays-Bas","Pérou","Philippines","Pologne","Portugal","Qatar","République centrafricaine","République dominicaine","République tchèque","Roumanie","Royaume-Uni","Russie","Rwanda","Saint-Christophe-et-Niévès","Saint-Marin","Saint-Vincent-et-les-Grenadines","Sainte-Lucie","Salvador","Samoa","Sao Tomé-et-Principe","Sénégal","Serbie","Seychelles","Sierra Leone","Singapour","Slovaquie","Slovénie","Somalie","Soudan","Soudan du Sud","Sri Lanka","Suède","Suisse","Suriname","Syrie","Tadjikistan","Tanzanie","Tchad","Thaïlande","Timor oriental","Togo","Tonga","Trinité-et-Tobago","Tunisie","Turkménistan","Turquie","Tuvalu","Ukraine","Uruguay","Vanuatu","Vatican","Venezuela","Viêt Nam","Yémen","Zambie","Zimbabwe"];
            const select = document.getElementById('clientPays');
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.innerText = country;
                select.appendChild(option);
            });
            select.value = "Côte d'Ivoire"; // Valeur par défaut
        }
        populateCountries();

    </script>
</body>
</html>
